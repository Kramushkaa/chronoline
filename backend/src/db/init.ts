import { readFileSync } from 'fs';
import { join } from 'path';
import pool from './connection';

export async function initDatabase() {
  const client = await pool.connect();
  
  try {
    console.log('ðŸ”„ Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…...');
    
    // Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° ÑƒÐ´Ð°Ð»ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ Ð¿Ñ€ÐµÐ´ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð¸ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñƒ Ð´Ð»Ñ Ñ‡Ð¸ÑÑ‚Ð¾Ð³Ð¾ Ð¿ÐµÑ€ÐµÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ
    await client.query('DROP VIEW IF EXISTS unique_countries');
    await client.query('DROP VIEW IF EXISTS unique_categories');
    await client.query('DROP TABLE IF EXISTS persons');
    console.log('ðŸ—‘ï¸ Ð¡Ñ‚Ð°Ñ€Ñ‹Ðµ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹ Ð¸ Ð¿Ñ€ÐµÐ´ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð¸Ñ ÑƒÐ´Ð°Ð»ÐµÐ½Ñ‹');


    const sql = readFileSync(join(__dirname, 'init.sql'), 'utf-8');
    await client.query(sql);
    
    console.log('âœ… Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð°');
    console.log('ðŸ“‹ Ð¡Ð¾Ð·Ð´Ð°Ð½Ñ‹ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹:');
    console.log('   - persons (Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð»Ð¸Ñ‡Ð½Ð¾ÑÑ‚Ð¸)');
    console.log('   - unique_categories (Ð¿Ñ€ÐµÐ´ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ)');
    console.log('   - unique_countries (Ð¿Ñ€ÐµÐ´ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ)');
    console.log('ðŸ“Š Ð¡Ð¾Ð·Ð´Ð°Ð½Ñ‹ Ð¸Ð½Ð´ÐµÐºÑÑ‹ Ð´Ð»Ñ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²');
    
  } catch (error) {
    console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…:', error);
    throw error;
  } finally {
    client.release();
  }
}

// Ð—Ð°Ð¿ÑƒÑÐº Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸, ÐµÑÐ»Ð¸ Ñ„Ð°Ð¹Ð» Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ÑÑ Ð½Ð°Ð¿Ñ€ÑÐ¼ÑƒÑŽ
if (require.main === module) {
  initDatabase()
    .then(() => {
      console.log('ðŸŽ‰ Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾');
      process.exit(0);
    })
    .catch((error) => {
      console.error('ðŸ’¥ ÐžÑˆÐ¸Ð±ÐºÐ°:', error);
      process.exit(1);
    });
} 